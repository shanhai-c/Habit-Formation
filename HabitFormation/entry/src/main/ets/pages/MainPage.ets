import router from '@ohos.router';
import { HabitData, HabitRecord, StatisticsData, CategoryColorConfig, CategoryStatData,} from '../pages/HabitTypes';
import { promptAction } from '@kit.ArkUI';

interface GeneratedTypeLiteralInterface_1 {
  index: number;
}

@Entry
@Component
struct MainPage {
  // çŠ¶æ€ç®¡ç†
  @State currentDate: string = this.getCurrentDate();
  @State currentHour: number = new Date().getHours();
  @State hasUnreadNotifications: boolean = true;
  @State selectedTab: number = 0; // 0:ä»Šæ—¥ä¹ æƒ¯, 1:å…¨éƒ¨ä¹ æƒ¯, 2:ç»Ÿè®¡
  @State habits: HabitData[] = this.getMockHabits();
  @State todayRecords: HabitRecord[] = [];
  @State isLoading: boolean = false;
  @State showAddHabitDialog: boolean = false;
  @State showStatistics: boolean = false;
  @State userName: string = 'ä¹ æƒ¯è¾¾äºº';
  @State selectedCategory: string = 'å…¨éƒ¨';
  @State newHabitName: string = '';
  @State newHabitCategory: string = 'å¥åº·';
  @State newHabitTarget: number = 30;
  @State statistics: StatisticsData = this.getDefaultStatistics();
  // é¡µé¢æ§åˆ¶å™¨
  private swiperController: SwiperController = new SwiperController();

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      this.buildTopBar()

      // æ—¥æœŸå’Œç»Ÿè®¡ä¿¡æ¯å¡ç‰‡
      this.buildDateCard()

      // æ ‡ç­¾é¡µåˆ‡æ¢
      this.buildTabBar()

      // å†…å®¹åŒºåŸŸ
      Swiper(this.swiperController) {
        // ä»Šæ—¥ä¹ æƒ¯
        this.buildTodayHabits()

        // å…¨éƒ¨ä¹ æƒ¯
        this.buildAllHabits()

        // ç»Ÿè®¡
        this.buildStatisticsPage()

      }
      .autoPlay(false) //è‡ªåŠ¨è½®æ’­
      .indicator(false) //å¯¼èˆªç‚¹
      .loop(true) //å…è®¸ç¬¬ä¸€é¡µç›´æ¥è½®æ’­åˆ°æœ€åä¸€é¡µæˆ–æœ€åä¸€é¡µç›´æ¥è½®æ’­åˆ°ç¬¬ä¸€é¡µ
      .vertical(false) //æ§åˆ¶è½®æ’­æ–¹å‘ï¼Œé»˜è®¤æ°´å¹³æ–¹å‘è½®æ’­
      //.displayArrowå¯¼èˆªç‚¹ç®­å¤´
      //æ ¹æ®æ–‡æ¡£ä¸­ç¤ºä¾‹å¯ä»¥åšä¸€ä¸ªé¡µé¢å¯¼èˆª
      // .displayCount(2)åŒæ—¶æ˜¾ç¤ºä¸¤ä¸ªé¡µé¢
      //.customContentTransitionè‡ªå®šä¹‰åˆ‡æ¢åŠ¨ç”»
      .index(this.selectedTab) //ç»‘å®šå½“å‰çš„ç´¢å¼•
      .onChange((index: number) => {
        this.selectedTab = index;
      }) //Tabsé¡µç­¾çš„åˆ‡æ¢

      this.buildFloatingActionButton() //æ‚¬æµ®æŒ‰é’®
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8FAFC')
  }

  // é¡¶éƒ¨å¯¼èˆªæ 
  @Builder
  buildTopBar() {
    Row() {
      // ç”¨æˆ·ä¿¡æ¯
      Row({ space: 12 }) {
        Image($r('app.media.logo'))
          .width(48)
          .height(48)
          .borderRadius(24)
          .border({ width: 2, color: '#FFFFFF' })
          .shadow({
            radius: 8,
            color: '#00000014',
            offsetX: 0,
            offsetY: 4
          })
        Column({ space: 4 }) {
          // æ ¹æ®æ—¶é—´æ®µæ˜¾ç¤ºé—®å€™è¯­
          Text(this.getGreetingByTime())
            .fontSize(14)
            .fontColor('#64748B')

          // ç”¨æˆ·å
          Text(this.userName)
            .fontSize(18)
            .fontColor('#1E293B')
            .fontWeight(FontWeight.Bold)
        }

        // åœ¨ buildTopBar() æ–¹æ³•çš„åˆé€‚ä½ç½®æ·»åŠ ï¼š
        TextClock()
          .format('H') // ç›‘å¬å°æ—¶
          .onDateChange(() => {
            this.currentHour = new Date().getHours();
          })
          .opacity(0) // éšè—æ˜¾ç¤º
          .height(0) // ä¸å ç”¨å¸ƒå±€ç©ºé—´

      }
      .layoutWeight(1)

      // é€šçŸ¥å’Œè®¾ç½®æŒ‰é’®
      Row({ space: 16 }) {

        Stack() {
          Image($r('app.media.notification'))
            .width(24)
            .height(24)

          // æ ¹æ®æ˜¯å¦æœ‰æœªè¯»é€šçŸ¥æ˜¾ç¤ºçº¢ç‚¹
          if (this.getUnreadNotificationCount() > 0) {
            Circle({ width: 8, height: 8 })
              .fill('#EF4444')
              .position({ x: 14, y: 2 })
          }
        }
        .onClick(() => {
          // ç‚¹å‡»åæ ‡è®°ä¸ºå·²è¯»ï¼ˆå¯é€‰ï¼‰
          this.hasUnreadNotifications = false;
          router.pushUrl({ url: 'pages/NotificationPage' });
        })

        Image($r('app.media.settings'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.pushUrl({ url: 'pages/SettingsPage' });
          })
      }

    }
    .width('100%')
    .padding({
      left: 20,
      right: 20,
      top: 12,
      bottom: 12
    })
    .backgroundColor('#FFFFFF')
  }

  // æ—¥æœŸå¡ç‰‡
  @Builder
  buildDateCard() {
    Column() {
      Row() {
        Text(this.currentDate)
          .fontSize(16)
          .fontColor('#1E293B')
          .fontWeight(FontWeight.Medium)

        Text('ç¬¬' + this.getWeekNumber() + 'å‘¨')
          .fontSize(14)
          .fontColor('#64748B')
          .margin({ left: 12 })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)

      // æœ¬å‘¨ç»Ÿè®¡ - ä½¿ç”¨å®é™…æ•°æ®
      Row({ space: 20 }) {
        Column({ space: 4 }) {
          Text(this.getTodayCompletion().toString())
            .fontSize(24)
            .fontColor('#10B981')
            .fontWeight(FontWeight.Bold)
          Text('ä»Šæ—¥å®Œæˆ')
            .fontSize(12)
            .fontColor('#64748B')
        }

        Divider().height(40).color('#E2E8F0').vertical(false)

        Column({ space: 4 }) {
          Text(this.statistics.totalHabits.toString())
            .fontSize(24)
            .fontColor('#3B82F6')
            .fontWeight(FontWeight.Bold)
          Text('æ€»ä¹ æƒ¯')
            .fontSize(12)
            .fontColor('#64748B')
        }

        Divider().height(40).color('#E2E8F0').vertical(false)

        Column({ space: 4 }) {
          Text(this.statistics.monthlyCompletionRate + '%')
            .fontSize(24)
            .fontColor('#8B5CF6')
            .fontWeight(FontWeight.Bold)
          Text('å®Œæˆç‡')
            .fontSize(12)
            .fontColor('#64748B')
        }
      }
      .width('100%')
      .padding({ top: 16, bottom: 16 })
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('92%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .margin({ top: 16, bottom: 16 })
    .shadow({
      radius: 12,
      color: '#0000000A',
      offsetX: 0,
      offsetY: 4
    })
  }

  // æ·»åŠ è¾…åŠ©æ–¹æ³•
  private getWeekNumber(): number {
    const now = new Date();
    const firstDayOfYear = new Date(now.getFullYear(), 0, 1);
    const pastDaysOfYear = (now.getTime() - firstDayOfYear.getTime()) / 86400000;
    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
  }

  private getTodayCompletion(): number {
    const todayHabits = this.habits.filter(h => h.isToday);
    return todayHabits.filter(h => h.completed).length;
  }

  // æ ‡ç­¾é¡µåˆ‡æ¢
  @Builder
  buildTabBar() {
    Row({ space: 0 }) {
      // ä»Šæ—¥ä¹ æƒ¯
      Column() {
        Text('ä»Šæ—¥ä¹ æƒ¯')
          .fontSize(16)
          .fontColor(this.selectedTab === 0 ? '#3B82F6' : '#64748B')
          .fontWeight(this.selectedTab === 0 ? FontWeight.Bold : FontWeight.Normal)

        if (this.selectedTab === 0) {
          Divider()
            .color('#3B82F6')
            .height(3)
            .width(24)
            .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .onClick(() => {
        this.selectedTab = 0; // åªéœ€è¦æ›´æ–°selectedTabï¼ŒSwiperä¼šè‡ªåŠ¨åˆ‡æ¢
      })

      // å…¨éƒ¨ä¹ æƒ¯
      Column() {
        Text('å…¨éƒ¨ä¹ æƒ¯')
          .fontSize(16)
          .fontColor(this.selectedTab === 1 ? '#3B82F6' : '#64748B')
          .fontWeight(this.selectedTab === 1 ? FontWeight.Bold : FontWeight.Normal)

        if (this.selectedTab === 1) {
          Divider()
            .color('#3B82F6')
            .height(3)
            .width(24)
            .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .onClick(() => {
        this.selectedTab = 1;
      })

      // ç»Ÿè®¡
      Column() {
        Text('ç»Ÿè®¡')
          .fontSize(16)
          .fontColor(this.selectedTab === 2 ? '#3B82F6' : '#64748B')
          .fontWeight(this.selectedTab === 2 ? FontWeight.Bold : FontWeight.Normal)

        if (this.selectedTab === 2) {
          Divider()
            .color('#3B82F6')
            .height(3)
            .width(24)
            .margin({ top: 8 })
        }
      }
      .layoutWeight(1)
      .onClick(() => {
        this.selectedTab = 2;
      })
    }
    .width('92%')
    .padding({ top: 8, bottom: 8 })
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ bottom: 16 })
  }

  // ä»Šæ—¥ä¹ æƒ¯é¡µé¢
  @Builder
  buildTodayHabits() {
    Column() {
      if (this.habits.filter(h => h.isToday).length === 0) {
        // ç©ºçŠ¶æ€
        Column({ space: 16 }) {
          Image($r('app.media.empty_state'))
            .width(200)
            .height(200)
          Text('ä»Šå¤©æ²¡æœ‰ä¹ æƒ¯ä»»åŠ¡')
            .fontSize(18)
            .fontColor('#64748B')
          Text('ä¼‘æ¯ä¸€ä¸‹ï¼Œæˆ–è€…æ·»åŠ æ–°ä¹ æƒ¯')
            .fontSize(14)
            .fontColor('#94A3B8')
        }
        .width('100%')
        .margin({ top: 60 })
      } else {
        // ä¹ æƒ¯åˆ—è¡¨
        List({ space: 12 }) {
          ForEach(this.habits.filter(h => h.isToday), (habit: HabitData) => {
            ListItem() {
              this.buildHabitCard(habit, true)
            }
          }, (habit: HabitData) => habit.id.toString())
        }
        .width('100%')
        .height('100%')
        .margin({ top: 8 })
        .edgeEffect(EdgeEffect.Spring)
      }
    }
    .width('100%')
    .height('100%')
    .padding({ left: 20, right: 20 })
  }

  // å…¨éƒ¨ä¹ æƒ¯é¡µé¢
  @Builder
  buildAllHabits() {
    Column() {
      // åˆ†ç±»ç­›é€‰ - ä½¿ç”¨ Scroll ç»„ä»¶å®ç°æ°´å¹³æ»šåŠ¨
      Scroll() {
        Row({ space: 8 }) {
          ForEach(['å…¨éƒ¨', 'å¥åº·', 'å­¦ä¹ ', 'å·¥ä½œ', 'ç”Ÿæ´»'], (category: string) => {
            Text(category)
              .fontSize(14)
              .fontColor(this.selectedCategory === category ? '#FFFFFF' : '#475569')
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .backgroundColor(this.selectedCategory === category ? '#3B82F6' : '#F1F5F9')
              .borderRadius(20)
              .onClick(() => {
                this.selectedCategory = category;
              })
          })
        }
        .width('100%')
        .padding({ right: 20 })
      }
      .width('100%')
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .margin({ bottom: 16 })

      // ä¹ æƒ¯åˆ—è¡¨
      if (this.getFilteredHabits().length === 0) {
        Column({ space: 16 }) {
          Image($r('app.media.empty_state'))
            .width(200)
            .height(200)
          Text('æš‚æ— ä¹ æƒ¯')
            .fontSize(18)
            .fontColor('#64748B')
          Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ–°ä¹ æƒ¯')
            .fontSize(14)
            .fontColor('#94A3B8')
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        List({ space: 12 }) {
          ForEach(this.getFilteredHabits(), (habit: HabitData) => {
            ListItem() {
              this.buildHabitCard(habit, false)
            }
          }, (habit: HabitData) => habit.id.toString())
        }
        .width('100%')
        .height('100%')
        .edgeEffect(EdgeEffect.Spring)
      }
    }
    .width('100%')
    .height('100%')
    .padding({ left: 20, right: 20 })
  }

  // è·å–ç­›é€‰åçš„ä¹ æƒ¯åˆ—è¡¨
  private getFilteredHabits(): HabitData[] {
    if (this.selectedCategory === 'å…¨éƒ¨') {
      return this.habits;
    } else {
      return this.habits.filter(h => h.category === this.selectedCategory);
    }
  }

  // ç»Ÿè®¡é¡µé¢
  @Builder
  buildStatisticsPage() {
    Column({ space: 20 }) {
      // ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡
      this.buildStatsOverview()

      // ä¹ æƒ¯åšæŒå¤©æ•°æ’è¡Œ
      this.buildHabitRanking()

      // åˆ†ç±»ç»Ÿè®¡
      this.buildCategoryStats()
    }
    .width('100%')
    .padding({ top: 20, bottom: 20 })
    .alignItems(HorizontalAlign.Center)
    // .scrollable(ScrollDirection.Vertical)
  }

  @Builder
  buildStatsOverview() {
    Column({ space: 16 }) {
      Row() {
        Text('ç»Ÿè®¡æ¦‚è§ˆ')
          .fontSize(18)
          .fontColor('#1E293B')
          .fontWeight(FontWeight.Bold)
      }
      .width('100%')

      Grid() {
        GridItem() {
          Column({ space: 4 }) {
            Text(this.statistics.totalHabits.toString())
              .fontSize(24)
              .fontColor('#3B82F6')
              .fontWeight(FontWeight.Bold)
            Text('æ€»ä¹ æƒ¯')
              .fontSize(12)
              .fontColor('#64748B')
          }
          .width('100%')
          .height(80)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: '#0000000A',
            offsetX: 0,
            offsetY: 2
          })
        }

        GridItem() {
          Column({ space: 4 }) {
            Text(this.statistics.completedToday.toString())
              .fontSize(24)
              .fontColor('#10B981')
              .fontWeight(FontWeight.Bold)
            Text('ä»Šæ—¥å®Œæˆ')
              .fontSize(12)
              .fontColor('#64748B')
          }
          .width('100%')
          .height(80)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: '#0000000A',
            offsetX: 0,
            offsetY: 2
          })
        }

        GridItem() {
          Column({ space: 4 }) {
            Text(this.statistics.currentStreak.toString())
              .fontSize(24)
              .fontColor('#F59E0B')
              .fontWeight(FontWeight.Bold)
            Text('æœ€é•¿è¿ç»­')
              .fontSize(12)
              .fontColor('#64748B')
          }
          .width('100%')
          .height(80)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: '#0000000A',
            offsetX: 0,
            offsetY: 2
          })
        }

        GridItem() {
          Column({ space: 4 }) {
            Text(this.statistics.monthlyCompletionRate + '%')
              .fontSize(24)
              .fontColor('#8B5CF6')
              .fontWeight(FontWeight.Bold)
            Text('å®Œæˆç‡')
              .fontSize(12)
              .fontColor('#64748B')
          }
          .width('100%')
          .height(80)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .shadow({
            radius: 8,
            color: '#0000000A',
            offsetX: 0,
            offsetY: 2
          })
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(12)
      .rowsGap(12)
      .width('92%')
    }
    .width('92%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#0000000A',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  buildAddHabitDialog() {
    if (this.showAddHabitDialog) {
      // ä½¿ç”¨Stackæ¥å åŠ é®ç½©å±‚å’Œå¯¹è¯æ¡†
      Stack() {
        // é®ç½©å±‚
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#00000040')
          .onClick(() => {
            this.showAddHabitDialog = false;
          })

        // å¯¹è¯æ¡†å†…å®¹
        Column({ space: 24 }) {
          Text('æ·»åŠ æ–°ä¹ æƒ¯')
            .fontSize(20)
            .fontColor('#1E293B')
            .fontWeight(FontWeight.Bold)

          // ä¹ æƒ¯åç§°
          Column({ space: 8 }) {
            Text('ä¹ æƒ¯åç§°')
              .fontSize(14)
              .fontColor('#475569')
              .width('100%')
              .textAlign(TextAlign.Start)

            TextInput({ placeholder: 'è¯·è¾“å…¥ä¹ æƒ¯åç§°' })
              .width('100%')
              .height(48)
              .fontSize(16)
              .padding({ left: 16, right: 16 })
              .backgroundColor('#F8FAFC')
              .borderRadius(8)
              .onChange((value: string) => {
                this.newHabitName = value;
              })
          }

          // åˆ†ç±»é€‰æ‹©
          Column({ space: 8 }) {
            Text('åˆ†ç±»')
              .fontSize(14)
              .fontColor('#475569')
              .width('100%')
              .textAlign(TextAlign.Start)

            Row({ space: 8 }) {
              ForEach(['å¥åº·', 'å­¦ä¹ ', 'å·¥ä½œ', 'ç”Ÿæ´»'], (category: string) => {
                Text(category)
                  .fontSize(14)
                  .fontColor(this.newHabitCategory === category ? '#FFFFFF' : '#475569')
                  .padding({
                    left: 16,
                    right: 16,
                    top: 8,
                    bottom: 8
                  })
                  .backgroundColor(this.newHabitCategory === category ? '#3B82F6' : '#F1F5F9')
                  .borderRadius(20)
                  .onClick(() => {
                    this.newHabitCategory = category;
                  })
              })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }

          // ç›®æ ‡å¤©æ•°
          Column({ space: 8 }) {
            Text('ç›®æ ‡å¤©æ•°')
              .fontSize(14)
              .fontColor('#475569')
              .width('100%')
              .textAlign(TextAlign.Start)

            Scroll() {
              Row({ space: 8 }) {
                ForEach([7, 21, 30, 60, 90], (days: number) => {
                  Text(days + 'å¤©')
                    .fontSize(14)
                    .fontColor(this.newHabitTarget === days ? '#FFFFFF' : '#475569')
                    .padding({
                      left: 16,
                      right: 16,
                      top: 8,
                      bottom: 8
                    })
                    .backgroundColor(this.newHabitTarget === days ? '#3B82F6' : '#F1F5F9')
                    .borderRadius(20)
                    .onClick(() => {
                      this.newHabitTarget = days;
                    })
                })
              }
            }
            .width('100%')
            .scrollable(ScrollDirection.Horizontal)
            .scrollBar(BarState.Off)
          }

          // æŒ‰é’®
          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .layoutWeight(1)
              .height(48)
              .fontColor('#64748B')
              .backgroundColor('#F1F5F9')
              .onClick(() => {
                this.showAddHabitDialog = false;
                this.newHabitName = '';
              })

            Button('æ·»åŠ ')
              .layoutWeight(1)
              .height(48)
              .fontColor('#FFFFFF')
              .backgroundColor('#3B82F6')
              .onClick(() => {
                this.addNewHabit();
              })
          }
          .width('100%')
        }
        .width('80%')
        .padding(24)
        .backgroundColor('#FFFFFF')
        .borderRadius(24)
        .shadow({
          radius: 24,
          color: '#00000020',
          offsetX: 0,
          offsetY: 8
        })
        .alignSelf(ItemAlign.Center)
        .margin({ top: '20%' })
      }
      .width('100%')
      .height('100%')
    }
  }

  @Builder
  buildHabitRanking() {
    Column({ space: 16 }) {
      Text('ä¹ æƒ¯åšæŒæ’è¡Œ')
        .fontSize(18)
        .fontColor('#1E293B')
        .fontWeight(FontWeight.Bold)
        .width('100%')

      if (this.habits.length === 0) {
        Text('æš‚æ— ä¹ æƒ¯æ•°æ®')
          .fontSize(14)
          .fontColor('#94A3B8')
          .width('100%')
          .textAlign(TextAlign.Center)
          .padding(20)
      } else {
        ForEach(this.getTopHabits(5), (habit: HabitData, index: number) => {
          Row({ space: 12 }) {
            // æ’å
            Column({ space: 4 }) {
              Text((index + 1).toString())
                .fontSize(16)
                .fontColor('#64748B')
                .fontWeight(FontWeight.Bold)

              if (index < 3) {
                Text(['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index])
                  .fontSize(12)
              }
            }
            .width(40)
            .alignItems(HorizontalAlign.Center)

            // ä¹ æƒ¯å›¾æ ‡
            Stack() {
              Circle()
                .width(48)
                .height(48)
                .fill(this.getCategoryColor(habit.category).background)

              Image($r('app.media.' + habit.icon))
                .width(24)
                .height(24)
            }

            // ä¹ æƒ¯ä¿¡æ¯
            Column({ space: 4 }) {
              Text(habit.name)
                .fontSize(16)
                .fontColor('#1E293B')
                .fontWeight(FontWeight.Medium)

              Row({ space: 8 }) {
                Text(habit.category)
                  .fontSize(12)
                  .fontColor('#64748B')

                Text('ç›®æ ‡' + habit.targetDays + 'å¤©')
                  .fontSize(12)
                  .fontColor('#94A3B8')
              }
            }
            .layoutWeight(1)

            // è¿ç»­å¤©æ•°
            Column({ space: 2 }) {
              Text(habit.currentStreak.toString())
                .fontSize(18)
                .fontColor('#10B981')
                .fontWeight(FontWeight.Bold)
              Text('å¤©')
                .fontSize(12)
                .fontColor('#94A3B8')
            }
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 8 })
        })
      }
    }
    .width('92%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#0000000A',
      offsetX: 0,
      offsetY: 4
    })
  }



  // è·å–åˆ†ç±»ç»Ÿè®¡æ•°æ®
  private getCategoryStatsData(): CategoryStatData[] {
    const categories: string[] = ['å¥åº·', 'å­¦ä¹ ', 'å·¥ä½œ', 'ç”Ÿæ´»'];

    // åˆ›å»ºç»Ÿè®¡æ•°ç»„
    const categoryStats = categories.map(category => {
      const habitsInCategory = this.habits.filter(h => h.category === category);
      const completed = habitsInCategory.filter(h => h.completed).length;
      const completionRate = habitsInCategory.length > 0
        ? Math.round((completed / habitsInCategory.length) * 100)
        : 0;

      return {
        category,
        count: habitsInCategory.length,
        completed,
        completionRate,
        color: this.getCategoryColor(category).primary
      } as CategoryStatData; // æ·»åŠ ç±»å‹æ–­è¨€
    });

    return categoryStats;
  }
  @Builder
  buildCategoryStats() {
    Column({ space: 16 }) {
      Text('åˆ†ç±»ç»Ÿè®¡')
        .fontSize(18)
        .fontColor('#1E293B')
        .fontWeight(FontWeight.Bold)
        .width('100%')

      // ä½¿ç”¨ç»„ä»¶æ–¹æ³•è·å–ç»Ÿè®¡æ•°æ®
      if (this.getCategoryStatsData().length === 0) {
        Text('æš‚æ— åˆ†ç±»æ•°æ®')
          .fontSize(14)
          .fontColor('#94A3B8')
          .width('100%')
          .textAlign(TextAlign.Center)
          .padding(20)
      } else {
        ForEach(this.getCategoryStatsData(), (stat: CategoryStatData) => {  // æ·»åŠ ç±»å‹æ³¨è§£
          Column({ space: 8 }) {
            Row() {
              Text(stat.category)
                .fontSize(16)
                .fontColor('#1E293B')
                .fontWeight(FontWeight.Medium)

              Text(stat.count + 'ä¸ªä¹ æƒ¯')
                .fontSize(14)
                .fontColor('#64748B')
                .margin({ left: 'auto' })
            }

            // è¿›åº¦æ¡
            Stack() {
              Row()
                .width('100%')
                .height(8)
                .backgroundColor('#E2E8F0')
                .borderRadius(4)

              Row()
                .width(stat.completionRate + '%')
                .height(8)
                .backgroundColor(stat.color)
                .borderRadius(4)
            }

            Row() {
              Text('å®Œæˆç‡ ' + stat.completionRate + '%')
                .fontSize(14)
                .fontColor('#475569')

              Text(stat.completed + '/' + stat.count + ' å®Œæˆ')
                .fontSize(12)
                .fontColor('#94A3B8')
                .margin({ left: 'auto' })
            }
          }
          .width('100%')
          .padding({ top: 12, bottom: 12 })
        })
      }
    }
    .width('92%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: '#0000000A',
      offsetX: 0,
      offsetY: 4
    })
  }

  // ä¹ æƒ¯å¡ç‰‡ç»„ä»¶
  @Builder
  buildHabitCard(habit: HabitData, isToday: boolean) {
    Column({ space: 12 }) {
      Row() {
        // ä¹ æƒ¯å›¾æ ‡å’Œåç§°
        Row({ space: 12 }) {
          // å›¾æ ‡èƒŒæ™¯
          Stack() {
            Circle()
              .width(48)
              .height(48)

            Image($r('app.media.' + habit.icon))
              .width(24)
              .height(24)

          }

          Column({ space: 4 }) {
            Text(habit.name)
              .fontSize(16)
              .fontColor('#1E293B')
              .fontWeight(FontWeight.Medium)
            Text(habit.reminder)
              .fontSize(12)
              .fontColor('#64748B')
          }
        }
        .layoutWeight(1)

        // æ‰“å¡æŒ‰é’®
        if (isToday && !habit.completed) {
          Button('æ‰“å¡', { type: ButtonType.Capsule })
            .width(80)
            .height(36)
            .fontColor('#FFFFFF')
            .fontSize(14)
            .onClick(() => {
              this.checkInHabit(habit.id);
            })
        } else if (habit.completed) {
          // å·²æ‰“å¡çŠ¶æ€
          Row({ space: 4 }) {
            Image($r('app.media.check'))
              .width(16)
              .height(16)

            Text('å·²å®Œæˆ')
              .fontSize(14)
              .fontColor('#10B981')
          }
          .padding({
            left: 12,
            right: 12,
            top: 8,
            bottom: 8
          })
          .backgroundColor('#D1FAE5')
          .borderRadius(18)
        }
      }

      // è¿›åº¦ä¿¡æ¯
      Row() {
        // åšæŒå¤©æ•°
        Text('å·²åšæŒ ' + habit.currentStreak + ' å¤©')
          .fontSize(12)
          .fontColor('#64748B')

        Text('ç›®æ ‡ ' + habit.targetDays + ' å¤©')
          .fontSize(12)
          .fontColor('#64748B')
          .margin({ left: 'auto' })
      }

      // è¿›åº¦æ¡
      Stack() {
        // èƒŒæ™¯æ¡
        Row()
          .width('100%')
          .height(6)
          .backgroundColor('#E2E8F0')
          .borderRadius(3)

        // è¿›åº¦æ¡
        Row()
          .width(this.calculateProgress(habit) + '%')
          .height(6)
          .borderRadius(3)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: '#0000000A',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => {
      router.pushUrl({
        url: 'pages/HabitDetailPage',
        params: { habitId: habit.id }
      });
    })
  }

  // æ‚¬æµ®æ“ä½œæŒ‰é’®
  @Builder
  buildFloatingActionButton() {
    // ä½¿ç”¨Stackå¹¶è®¾ç½®å¯¹é½æ–¹å¼ä¸ºå³ä¸‹è§’
    Stack({ alignContent: Alignment.BottomEnd }) {
      // ä¸»æŒ‰é’®
      Button('', { type: ButtonType.Circle })
        .width(56)
        .height(56)
        .backgroundColor('#3B82F6')
        .shadow({
          radius: 16,
          color: '#3B82F680',
          offsetX: 0,
          offsetY: 8
        })
        .onClick(() => {
          this.showAddHabitDialog = true;
        })
        .margin({ right: 20, bottom: 20 })

      // åŠ å·å›¾æ ‡
      Image($r('app.media.add'))
        .width(24)
        .height(24)
        .position({ x: 16, y: 16 })
    }
    .width('100%')
    .height('100%')
  }

  // å·¥å…·æ–¹æ³•
  private getCurrentDate(): string {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const day = now.getDate();
    const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    const weekDay = weekDays[now.getDay()];
    return `${year}å¹´${month}æœˆ${day}æ—¥ æ˜ŸæœŸ${weekDay}`;
  }

  // ä½¿ç”¨ switch-case æ–¹æ¡ˆï¼ˆæœ€ç®€å•ï¼‰
  private getCategoryColor(category: string): CategoryColorConfig {
    switch (category) {
      case 'å¥åº·':
        return {
          primary: '#10B981',
          background: '#D1FAE5',
          icon: '#059669'
        };
      case 'å­¦ä¹ ':
        return {
          primary: '#8B5CF6',
          background: '#EDE9FE',
          icon: '#7C3AED'
        };
      case 'å·¥ä½œ':
        return {
          primary: '#3B82F6',
          background: '#DBEAFE',
          icon: '#1D4ED8'
        };
      case 'ç”Ÿæ´»':
      default:
        return {
          primary: '#F59E0B',
          background: '#FEF3C7',
          icon: '#D97706'
        };
    }
  }

  private calculateProgress(habit: HabitData): number {
    return Math.min(100, (habit.currentStreak / habit.targetDays) * 100);
  }

  private getTopHabits(count: number): HabitData[] {
    return [...this.habits]
      .sort((a, b) => b.currentStreak - a.currentStreak)
      .slice(0, count);
  }


  // æ ¹æ®å½“å‰æ—¶é—´è·å–é—®å€™è¯­
  private getGreetingByTime(): string {
    const hour = this.currentHour; // 0-23

    if (hour >= 0 && hour < 5) {
      return 'å‡Œæ™¨å¥½'; // 00:00 - 05:00
    } else if (hour >= 5 && hour < 8) {
      return 'æ—©ä¸Šå¥½'; // 05:00 - 08:00
    } else if (hour >= 8 && hour < 11) {
      return 'ä¸Šåˆå¥½'; // 08:00 - 11:00
    } else if (hour >= 11 && hour < 13) {
      return 'ä¸­åˆå¥½'; // 11:00 - 13:00
    } else if (hour >= 13 && hour < 17) {
      return 'ä¸‹åˆå¥½'; // 13:00 - 17:00
    } else if (hour >= 17 && hour < 18) {
      return 'å‚æ™šå¥½'; // 17:00 - 18:00
    } else {
      return 'æ™šä¸Šå¥½'; // 18:00 - 24:00
    }
  }

  // è®¡ç®—æœªè¯»é€šçŸ¥æ•°é‡
  private getUnreadNotificationCount(): number {
    // è¿™é‡Œå¯ä»¥è¿æ¥å®é™…çš„é€šçŸ¥æ•°æ®
    return this.hasUnreadNotifications ? 1 : 0;
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶åŠ è½½æ•°æ®
  onPageShow() {
    this.loadHabits();
    this.updateStatistics();
  }

  // åŠ è½½ä¹ æƒ¯æ•°æ®
  private loadHabits(): void {
    // è¿™é‡Œå¯ä»¥ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
    // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
    this.habits = this.getMockHabits();
    this.updateStatistics();
  }

  // è·å–é»˜è®¤ç»Ÿè®¡æ•°æ®
  private getDefaultStatistics(): StatisticsData {
    return {
      totalHabits: 0,
      completedToday: 0,
      totalCheckIns: 0,
      currentStreak: 0,
      monthlyCompletionRate: 0
    };
  }

  // æ›´æ–°ç»Ÿè®¡æ•°æ®
  private updateStatistics(): void {
    const today = new Date();
    const todayHabits = this.habits.filter(h => h.isToday);
    const completedToday = todayHabits.filter(h => h.completed).length;

    // è®¡ç®—æœ€é•¿è¿ç»­å¤©æ•°
    const currentStreak = this.habits.length > 0
      ? Math.max(...this.habits.map(h => h.currentStreak))
      : 0;

    // è®¡ç®—æ€»æ‰“å¡æ¬¡æ•°
    const totalCheckIns = this.habits.reduce((sum, habit) => sum + (habit.totalCheckIns || 0), 0);

    // è®¡ç®—æœˆåº¦å®Œæˆç‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
    const monthlyCompletionRate = todayHabits.length > 0
      ? Math.round((completedToday / todayHabits.length) * 100)
      : 0;

    this.statistics = {
      totalHabits: this.habits.length,
      completedToday,
      totalCheckIns,
      currentStreak,
      monthlyCompletionRate
    };
  }

  // æ›´æ–° getMockHabits æ–¹æ³•
  private getMockHabits(): HabitData[] {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    return [
      {
        id: 1,
        name: 'æ—©èµ·',
        description: 'æ¯å¤©æ—©ä¸Š6ç‚¹å‰èµ·åºŠ',
        icon: 'sunrise',
        category: 'å¥åº·',
        targetDays: 30,
        currentStreak: 15,
        completed: false,
        isToday: true,
        reminder: '06:00',
        createdAt: new Date(2024, 0, 1),
        lastCheckInDate: new Date(2024, 0, 14),
        totalCheckIns: 15
      },
      {
        id: 2,
        name: 'é˜…è¯»30åˆ†é’Ÿ',
        description: 'æ¯å¤©é˜…è¯»ä¹¦ç±30åˆ†é’Ÿ',
        icon: 'book',
        category: 'å­¦ä¹ ',
        targetDays: 365,
        currentStreak: 45,
        completed: true,
        isToday: true,
        reminder: '20:00',
        createdAt: new Date(2023, 11, 1),
        lastCheckInDate: today,
        totalCheckIns: 45
      },
      {
        id: 3,
        name: 'è¿åŠ¨é”»ç‚¼',
        description: 'æ¯å¤©è¿åŠ¨30åˆ†é’Ÿ',
        icon: 'fitness',
        category: 'å¥åº·',
        targetDays: 90,
        currentStreak: 28,
        completed: false,
        isToday: true,
        reminder: '19:00',
        createdAt: new Date(2024, 0, 15),
        lastCheckInDate: new Date(2024, 0, 14),
        totalCheckIns: 28
      },
      {
        id: 4,
        name: 'å­¦ä¹ è‹±è¯­',
        description: 'èƒŒå•è¯30ä¸ª',
        icon: 'language',
        category: 'å­¦ä¹ ',
        targetDays: 180,
        currentStreak: 65,
        completed: false,
        isToday: false,
        reminder: '09:00',
        createdAt: new Date(2023, 10, 1),
        lastCheckInDate: new Date(2024, 0, 14),
        totalCheckIns: 65
      },
      {
        id: 5,
        name: 'å†™æ—¥è®°',
        description: 'è®°å½•æ¯å¤©çš„ç”Ÿæ´»',
        icon: 'journal',
        category: 'ç”Ÿæ´»',
        targetDays: 100,
        currentStreak: 42,
        completed: true,
        isToday: false,
        reminder: '22:00',
        createdAt: new Date(2023, 11, 15),
        lastCheckInDate: today,
        totalCheckIns: 42
      }
    ];
  }

  // æ‰“å¡æ–¹æ³•
  private checkInHabit(habitId: number): void {
    const habitIndex = this.habits.findIndex(h => h.id === habitId);
    if (habitIndex === -1) return;

    const habit = this.habits[habitIndex];
    const today = new Date();

    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»æ‰“å¡
    if (habit.completed) {
      promptAction.showToast({
        message: 'ä»Šå¤©å·²ç»æ‰“å¡è¿‡äº†ï¼',
        duration: 2000
      });
      return;
    }

    // è®¡ç®—è¿ç»­å¤©æ•°
    let newStreak = 1;
    if (habit.lastCheckInDate) {
      const lastDate = new Date(habit.lastCheckInDate);
      lastDate.setHours(0, 0, 0, 0);

      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      yesterday.setHours(0, 0, 0, 0);

      if (lastDate.getTime() === yesterday.getTime()) {
        // æ˜¨å¤©æ‰“å¡äº†ï¼Œè¿ç»­å¤©æ•°+1
        newStreak = habit.currentStreak + 1;
      }
    }

    // æ›´æ–°ä¹ æƒ¯ - ä¸ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦
    const updatedHabit: HabitData = {
      id: habit.id,
      name: habit.name,
      description: habit.description,
      icon: habit.icon,
      category: habit.category,
      targetDays: habit.targetDays,
      currentStreak: newStreak,
      completed: true,
      isToday: habit.isToday,
      reminder: habit.reminder,
      createdAt: habit.createdAt,
      lastCheckInDate: today,
      totalCheckIns: (habit.totalCheckIns || 0) + 1
    };

    // æ›´æ–°æ•°ç»„
    this.habits[habitIndex] = updatedHabit;
    this.habits = [...this.habits];

    // æ›´æ–°ç»Ÿè®¡
    this.updateStatistics();

    promptAction.showToast({
      message: `æ‰“å¡æˆåŠŸï¼å·²è¿ç»­${newStreak}å¤©`,
      duration: 2000
    });
  }
  // æ·»åŠ æ–°ä¹ æƒ¯
  private addNewHabit(): void {
    if (!this.newHabitName.trim()) {
      promptAction.showToast({
        message: 'è¯·è¾“å…¥ä¹ æƒ¯åç§°',
        duration: 2000
      });
      return;
    }

    const newHabit: HabitData = {
      id: this.habits.length > 0 ? Math.max(...this.habits.map(h => h.id)) + 1 : 1,
      name: this.newHabitName,
      description: 'åšæŒå°±æ˜¯èƒœåˆ©ï¼',
      icon: this.getIconByCategory(this.newHabitCategory),
      category: this.newHabitCategory,
      targetDays: this.newHabitTarget,
      currentStreak: 0,
      completed: false,
      isToday: true,
      reminder: '08:00',
      createdAt: new Date(),
      totalCheckIns: 0
    };

    this.habits = [...this.habits, newHabit];
    this.updateStatistics();
    this.newHabitName = '';
    this.showAddHabitDialog = false;

    promptAction.showToast({
      message: 'ä¹ æƒ¯æ·»åŠ æˆåŠŸ',
      duration: 2000
    });
  }

  // æ ¹æ®åˆ†ç±»è·å–å›¾æ ‡
  private getIconByCategory(category: string): string {
    const icons: Record<string, string> = {
      'å¥åº·': 'sunrise',
      'å­¦ä¹ ': 'book',
      'å·¥ä½œ': 'briefcase',
      'ç”Ÿæ´»': 'journal'
    };
    return icons[category] || 'sunrise';
  }

  // åˆ é™¤ä¹ æƒ¯
  private deleteHabit(habitId: number): void {
    promptAction.showDialog({
      title: 'åˆ é™¤ä¹ æƒ¯',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿåˆ é™¤åå°†æ— æ³•æ¢å¤ã€‚',
      buttons: [
        { text: 'å–æ¶ˆ', color: '#64748B' },
        { text: 'åˆ é™¤', color: '#EF4444' }
      ]
    }).then((data: GeneratedTypeLiteralInterface_1) => {
      if (data.index === 1) {
        this.habits = this.habits.filter(h => h.id !== habitId);
        this.updateStatistics();
        promptAction.showToast({
          message: 'ä¹ æƒ¯å·²åˆ é™¤',
          duration: 2000
        });
      }
    });
  }


}
